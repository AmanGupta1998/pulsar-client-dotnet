name: .NET Core Ubuntu

on: [pull_request, push]

jobs:
  build:
  
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Setup minikube
      uses: medyagh/setup-minikube@master
        
    - name: Init cluster
      run: |
        kubectl cluster-info
        kubectl get pods -n kube-system
        export MINIKUBE_IP=$(minikube ip)
        cd tests/minikuber
        kubectl create namespace pulsartest
        kubectl apply -f . -n pulsartest

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.100

    - name: Install dotnet tools locally
      run: dotnet tool restore

    - name: Paket Install
      run: dotnet paket install
    
    - name: Dotnet Restore
      run: dotnet restore
    
    - name: Dotnet Build Release
      run: dotnet build -c Release --no-restore
    
    - name: Apt-get Install Snappy & ZSTD
      run: |
        sudo apt-get install -y libsnappy-dev
        sudo apt-get install -y libzstd-dev
    
    - name: Run Unit Tests
      run: |
        cd tests/UnitTests
        dotnet run -c Release --no-build

    - name: Check $MINIKUBE_IP
      run: echo $MINIKUBE_IP
      
    - name: Wait proxy
      uses: nev7n/wait_for_response@v1
      with:
        url: 'http://$MINIKUBE_IP:30001/status.html'
        responseCode: '200'
        timeout: 2000
        interval: 1000

    - name: kubectl status
      run: |
        kubectl get pod -n pulsartest

#    - name: Run Integration Tests
#      timeout-minutes: 2
#      run: |
#        cd tests/IntegrationTests
#        dotnet run --no-spinner --debug
